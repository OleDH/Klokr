@page "/"
@rendermode InteractiveServer
@inject HttpClient Http
@using System.Text.Json;

<h1 class="mb-4">Klokr Dashboard</h1>

<div class="mb-4">
    <button class="btn btn-outline-primary" @onclick="ToggleForm">
        @(showForm ? "Hide Form" : "Add New Todo")
    </button>
</div>

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-body">
            <EditForm Model="@NewClockedItem" OnValidSubmit="@HandleSubmit" FormName="AddTodoForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Activity: <span class="text-danger">*</span></label>
                        <InputText @bind-Value="NewClockedItem.Activity" class="form-control" required />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Frequency:</label>
                        <InputNumber @bind-Value="NewClockedItem.Frequency" class="form-control" />
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Priority:</label>
                        <InputNumber @bind-Value="NewClockedItem.Priority" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Due By:</label>
                        <InputDate @bind-Value="NewClockedItem.DueBy" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Baseline:</label>
                        <InputNumber @bind-Value="NewClockedItem.Baseline" class="form-control" />
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <InputCheckbox @bind-Value="NewClockedItem.Recurring" class="form-check-input" />
                            <label class="form-check-label">Recurring Task</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Snoozed:</label>
                        <InputNumber @bind-Value="NewClockedItem.Snoozed" class="form-control" />
                    </div>
                </div>
                
                <div class="d-flex gap-2">
                    <input type="submit" value="Add Todo" class="btn btn-primary" />
                    <button type="button" class="btn btn-secondary" @onclick="CancelForm">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

<div class="container mt-4">
    @if (items == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
        </div>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead class="table-dark">
            <tr>
                <th>Activity</th>
                <th>Frequency</th>
                <th>Priority</th>
                <th>Created</th>
                <th>ClosedAt</th>
                <th>DueBy</th>
                <th>Recurring</th>
                <th>Snoozed</th>
                <th>Baseline</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in items)
            {
                <tr>
                    <td class="text-truncate" style="max-width: 200px;" title="@item.Value.Activity">
                        @item.Value.Activity
                    </td>
                    <td>@item.Value.Frequency</td>
                    <td>@item.Value.Priority</td>
                    <td>@item.Value.CreatedAt.ToString("dd MMM")</td>
                    <td>@(item.Value.ClosedAt == DateTime.MinValue ? "-" : item.Value.ClosedAt.ToString("dd MMM"))</td>
                    <td>@(item.Value.DueBy == DateTime.MinValue ? "-" : item.Value.DueBy.ToString("dd MMM"))</td>
                    <td>@item.Value.Recurring</td>
                    <td>@item.Value.Snoozed</td>
                    <td>@item.Value.Baseline</td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>


@code {
    private bool showForm = false;
    private Dictionary<string, ClockedItem>? items;
    private ClockedItem NewClockedItem = new();

    protected override async Task OnInitializedAsync()
    {
        items = await Http.GetFromJsonAsync<Dictionary<string, ClockedItem>>("http://backend:8080/todos");
    }

    private void ToggleForm()
    {
        showForm = !showForm;
        Console.WriteLine($"showForm is now: {showForm}"); 
    }
    
    private void CancelForm()
    {
        showForm = false;
        NewClockedItem = new();
    }

    private async Task HandleSubmit()
    {
        NewClockedItem.CreatedAt = DateTime.Now;
        await Http.PostAsJsonAsync("http://backend:8080/todos", NewClockedItem);
        items = await Http.GetFromJsonAsync<Dictionary<string, ClockedItem>>("http://backend:8080/todos");
        NewClockedItem = new();
        showForm = false;
    }

    public class ClockedItem
    {
        public string Activity { get; set; } = "";
        public int Frequency { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime ClosedAt { get; set; }
        public DateTime DueBy { get; set; }
        public int Priority { get; set; }
        public bool Recurring { get; set; }
        public int Snoozed { get; set; }
        public int Baseline { get; set; }
    }
}